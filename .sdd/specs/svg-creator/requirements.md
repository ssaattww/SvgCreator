# 要件定義書

## 機能概要
`.sdd/description.md` の記述に基づき、入力画像をベクタライズして SVG を生成する機能を提供する。実装言語は C# を想定。参考資料（arXiv, GitHub リポジトリ）への言及はあるが、要件は本書で定義する。

## ユーザーストーリー
- ユーザーとして、凸集合のレイヤー構造になる SVG デカールを生成したい。なぜなら Gran Turismo のデカール作成において、非凸な分割ではゲーム内での位置合わせが難しく、分割デカール間に隙間が生じやすい一方、すべてを凸集合レイヤーとして重ねれば厳密な位置合わせなしで利用できるから。

## 機能要件
 - 設計は、以下の資料を調査して行うこと（参考: https://github.com/marklaw1006/Image-Vectorization-with-Depth?tab=Apache-2.0-1-ov-file#readme, https://arxiv.org/html/2409.06648v1）。
### 要件1：画像入力の受け取り
- ローカルの画像ファイル（例：PNG/JPEG）を入力として受け取れること。
- 受入基準：
  - [ ] 有効な画像ファイルを指定した場合、処理が開始されること
  - [ ] 無効なパスや非対応形式の場合、ユーザーにエラーメッセージを提示すること

### 要件2：凸レイヤー構造の SVG 生成
- 入力画像をベクタ化し、凸集合のレイヤー構造（Layer 1, Layer 2, ...）として出力すること。
- 各レイヤーは凸な形状（自己交差なし、穴なし）で構成されることを目標とする。
- 受入基準：
  - [ ] 各レイヤーのパスが単一の連結で自己交差を持たないこと
  - [ ] 多角形近似した際に全内角が180°以下（凸性チェック）を満たすこと
  - [ ] 定義したレイヤー順に重ね合わせたとき、レイヤーの境界に隙間が生じないこと（ピクセル比較などでギャップがないこと）

### 要件3：出力
- 拡張子 `.svg` のファイルとして保存できること。
- レイヤーは SVG のグループ（例：`<g id="layer-001">`）として識別可能で、重ね順が保持されること。
- 受入基準：
  - [ ] 一般的な SVG ビューアで表示可能であること
  - [ ] レイヤー（グループ）順がメタデータまたは要素順で再現できること

### 要件4：レイヤーサイズ制約
- 各レイヤーを単独の SVG として書き出した場合、ファイルサイズが 15KB（= 15,360 bytes）未満であること。
- 受入基準：
  - [ ] 任意のレイヤーを書き出した際、SVG ファイルサイズが 15KB 未満であること

### 要件5：各レイヤーの個別出力
- 指定したレイヤーのみを単独の SVG として書き出せること（複数レイヤーの一括指定にも対応）。
- 受入基準：
  - [ ] `--export-layer <id[,id...]>` 等の指定で対象レイヤーのみを書き出せること
  - [ ] 出力ファイル名がレイヤー ID を含むこと（例：`out/layer-003.svg`）
  - [ ] 個別出力でも要件4（15KB未満）を満たすこと

### 要件6：進捗表示
- 長時間処理に対してコンソールへ進捗を表示すること（ステージ/パーセンテージ/残り推定のいずれか）。
- 受入基準：
  - [ ] 主要ステージ開始/完了のログが表示されること（例：前処理→分割→輪郭→最適化→出力）
  - [ ] 1秒以上かかる処理では少なくとも1秒ごとに進捗が更新されること
  - [ ] `--quiet` で抑制し、`--verbose` で詳細表示が可能であること

### 要件7：コンソールアプリケーション（CLI）
- GUI を持たないコンソールアプリケーションとして提供すること。
- 受入基準：
  - [ ] `--help` で使用方法と主要オプションが表示されること
  - [ ] 入力/出力パス、`--threads`、`--quality`、`--export-layer` などのオプションに対応すること
  - [ ] 正常終了で終了コード 0、エラー時は非 0 を返すこと

## 非機能要件
- パフォーマンス（並列化・高速化）
  - [ ] 主要工程（領域分割、輪郭抽出、ポリゴン処理、レイヤー合成）がマルチスレッド/並列処理でスケールすること
  - [ ] スレッド数を1とNに変更しても、同一入力に対する生成SVGが内容的に同一であること（順序差のみ許容）
  - [ ] `--threads` などの設定でスレッド数を指定できること（既定は論理CPU数）
  - [ ] `--quality` などの設定で精度/速度のプリセットを選択できること（fast/balanced/high など）
  - [ ] 代表入力に対し、スレッド数を増やすと処理時間が短縮すること（ベンチマーク手順を付属）
- セキュリティ：[必要に応じて定義]
- ライセンス遵守（Apache-2.0 起源の利用）
  - [ ] ルートに `LICENSE`（Apache License 2.0 原文）を配置すること
  - [ ] ルートに `NOTICE` または同等の第三者表示ファイルを配置し、元実装（例：`https://github.com/marklaw1006/Image-Vectorization-with-Depth`）の著作権表示・ライセンス・必要な告知を記載すること
  - [ ] `README.md` に「本プロジェクトは Apache License 2.0 に基づく元実装に着想・一部コード/手法を参照している」旨とライセンスへのリンクを明記すること
  - [ ] 改変箇所がある場合は、適切な場所（該当ファイルのヘッダや `CHANGES.md`）で改変の事実を告知すること（Apache-2.0 の要件）
  - [ ] バイナリ配布時はライセンスと NOTICE の同梱を行うこと
 - コード品質・ドキュメント（XML ドキュメントコメント）
   - [ ] 各ソースファイルの冒頭に、そのファイルの目的を示すヘッダーコメント（XML ドキュメント形式または同等の整形コメント）を記載すること
   - [ ] すべての公開型（class/struct/interface/enum/delegate/record）に `/// <summary>…</summary>` を付与すること
   - [ ] すべての公開メンバー（メソッド/コンストラクタ/プロパティ/フィールド/イベント）に `/// <summary>…</summary>` を付与し、引数がある場合は `/// <param name="…">…</param>`、戻り値がある場合は `/// <returns>…</returns>` を記載すること
   - [ ] 例外を送出しうる場合は `/// <exception cref="…">…</exception>` を記載すること
   - [ ] ビルド設定で XML ドキュメント出力（`<GenerateDocumentationFile>true</GenerateDocumentationFile>`）を有効化し、CI では公開 API に対する欠落ドキュメント警告（例：CS1591）が発生しないこと
