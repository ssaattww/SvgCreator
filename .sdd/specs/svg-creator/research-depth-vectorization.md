# 画像ベクタライズにおける「深度（前後関係）付き」レイヤー分解 調査ノート

- 目的: SvgCreator で「前後関係」をもつレイヤー分解つきベクタライズを実現するため、関連手法の把握と適用方針をまとめる。
- 対象: 仕様策定者、実装担当、レビュー担当。
- 対応範囲: 参照資料に基づく技術要点の抽出、SvgCreator への適用設計、ライセンス留意点。

## 参考資料
- GitHub: Image-Vectorization-with-Depth（Apache-2.0）: https://github.com/marklaw1006/Image-Vectorization-with-Depth
- arXiv: Image Vectorization with Depth（v1 2024-09-10 公開）: https://arxiv.org/abs/2409.06648

## 要約（結論）
- 参照論文は、画像を「前後関係（深度順）」をもつ形状レイヤーへと分解する画像幾何ベースの方法を提示している。循環（閉路）を避ける深度順の決定と、遮蔽で途切れた輪郭の補完（曲率ベースのエラスティカ・インペインティング）を組み合わせ、直観的なレイヤー分離を得ることを狙う。成果はベクタ編集に有用なレイヤー分解を提供する。［出典: arXiv 要旨］
- 公開 GitHub リポジトリは Apache-2.0 ライセンスで配布されている（ライセンス表記より）。本仕様に取り込む際は NOTICE/帰属を適切に行う。［出典: GitHub リポジトリ表示］

## 技術概要（出典の整理）
- 深度順の定式化と最適化
  - 画像中の形状（領域）間の「どちらが手前か」を表す有向関係を構築し、循環が生じないように順序化（トポロジカルな前後関係）を得る。論文は「深度順のエネルギー（depth ordering energy）」を設計し、閉路を避けつつ一貫性のある順序を求めると述べる。［arXiv 要旨］
- 遮蔽部の補完（曲率ベースのインペインティング）
  - 遮蔽により途切れた形状を、ユーザの知覚に合う滑らかな輪郭として補う目的で、ユークリッド幾何に基づく曲率正則化（Euler's elastica）を用いたインペインティングを行う。［arXiv 要旨］
- 安定化のためのエネルギー設計
  - 形状の充填・境界推定の安定化に Modica–Mortola 型の二重井戸（double-well）エネルギーを改良して利用する、と要旨にある。［arXiv 要旨］
- 目的
  - 「ベクタ編集に有用な直観的レイヤー分離」を提供する点を強調。ピクセルの写実的再現ではなく、編集可能な幾何（レイヤー＋輪郭）を得ることに主眼がある。［arXiv 要旨］

出典の確認が可能な情報は要旨レベルに留まるため、具体的な損失関数の式やアルゴリズム詳細（最適化手法・ハイパラ）は論文本文の参照が必要。現時点では SvgCreator 取り込みにおけるアーキテクチャ指針を中心に提示する。

## SvgCreator への適用方針（提案）
以下は出典の考え方を踏まえた、実装しやすい構成案（提案）である。実装詳細は本リポジトリの要件（例: レイヤ毎 15KB 以内）に合わせて調整する。

- 入力前処理
  - 必要に応じて減色（例: K=8〜16）とノイズ除去を実施し、領域の一貫性を高める。
- 形状抽出（領域・境界）
  - 接続成分抽出で候補領域を得る。境界は細線化やエッジ追跡で抽出。
- 形状間グラフ（隣接・重なり）
  - 領域の接触・重なり候補から有向グラフを作成。各辺に「どちらが手前か」のスコア（後述の depth energy 構成要素で近似）を付与。
- 深度順最適化（循環排除）
  - 有向辺重みをもつランキング問題として近似し、閉路最小化（例: フィードバック弧集合近似、あるいは連続最適化後の丸め）で部分順序→全順序へ。
- 遮蔽輪郭の補完（エラスティカ近似）
  - 途切れた境界を滑らかに接続する補間を行う。計算量と実装容易性の観点から、厳密なエラスティカ最小化の代替として、曲率二乗＋長さペナルティをもつスプライン最適化で近似する実装案を提示。
- ベクタ化とレイヤリング
  - 補完後の輪郭を SVG Path（`M/C/Q`）へ近似（曲率変化に応じた適応分割で制御点数を削減）。深度順に `<g id="layer-XXX">` として出力。
- メタデータ
  - 各レイヤに深度インデックス・親子関係・由来領域IDをメタとして保持。

## 推奨インタフェース（入出力）
- 入力: ラスタ画像（PNG/JPEG）
- 出力: 深度順レイヤ付き SVG
  - ルートに `viewBox` を設定。
  - レイヤ: `<g id="layer-000" data-depth="0"> ... </g>`（depth は 0=最奥）
  - 形状: `<path id="shape-..." d="..."/>`（元領域ID、信頼度を `data-*` で付与）

## Depth Energy（実装の指針：提案）
要旨では具体式は開示されていないため、実装用の設計指針を提案する。
- 設計要素（例）
  - 終端一致: 隣接境界の“端点”の連続性が高いほど「手前が遮蔽している」可能性を上げる。
  - 角度整合: 境界延長の接線方向が滑らかに繋がるほど手前解を支持。
  - 色・明度コントラスト: 手前にあると知覚されやすい側（周辺コントラスト等）。
  - 領域面積・凸性: 大きく凸な領域は「背景」仮説を支持しやすい等の事前分布。
- 最適化
  - 各ペアに手前/奥のスコアを付け、全体で閉路（矛盾）を最小化するランク学習／整序最適化に帰着。

## エラスティカ補完の実装（近似案）
- 近似目的関数: `λc * ∫ κ^2 ds + λl * length` を最小化するスプライン制御点最適化（数値安定性のため離散曲率近似）。
- 拘束: 端点位置・接線方向の連続性、自己交差回避（反復時のペナルティ）。
- 数値: L-BFGS などの準ニュートン法、粗密多段最適化で収束性を確保。

## 品質と容量（要件適合）
- レイヤ別 15KB 以内を満たすため、パス単純化（RDP 変種＋曲率閾値）と色数制御を併用。
- 部分出力（レイヤ抽出）に対応し、`out/layer-003.svg` のようなファイル分割を許容。

## ライセンス留意点（Apache-2.0）
- 参照実装・記述を取り込む場合は Apache-2.0 の条件に従い、`LICENSE` と `NOTICE` を配置し、出典（GitHub リポジトリ）を明示する。
- 改変がある場合は変更点の明示（`CHANGES.md` 等）を検討。

## 既知のリスク/制限（現時点）
- 画像内容によっては深度順の曖昧さや矛盾（閉路）が残る可能性。
- 複雑なトポロジでは厳密なエラスティカ最小化が計算的に高コスト。
- 凸化／滑らか化により、元画像の微細形状が失われるリスク。

## 次アクション
- 論文本文の詳細（エネルギー式、最適化詳細）の精読とプロトタイプ実装。
- 既存 `requirements.md` の容量・CLI 仕様に合わせた I/O とオプション設計の確定。

---
参考:
- Image-Vectorization-with-Depth（GitHub, Apache-2.0）: https://github.com/marklaw1006/Image-Vectorization-with-Depth
- Image Vectorization with Depth（arXiv 2409.06648）: https://arxiv.org/abs/2409.06648

---

# 設計に向けた詳細（章節付き引用）

本節では、後続の設計・実装ができる粒度で手法を分解し、arXiv v1 HTML の節番号に基づく出典を併記する。

## 全体像（パイプライン）
- 概観: 量子化→形状レイヤ抽出→ペア毎の前後スコア→グローバル整序（循環回避）→遮蔽補完（エラスティカ）→ベクタ化→SVG出力。［Sec. 2.5, Fig. 2; Appx. A Pseudo Code］
- 目的: 「編集容易なレイヤ分離」を最優先とし、幾何学的に滑らかな境界と一貫した深度順を得る。［Sec. 1; Sec. 6.2］

## 1) 形状レイヤの取得と前処理
- 色量子化: 小規模 K（例: 8〜32）で量子化して領域の一貫性を高める（具体的 K は設計側で調整）。［Sec. 2.5（処理の概観）］
- 連結成分: 量子化後の各色ごとに連結成分抽出し、候補 shape layer を得る。微小領域の除去や簡略化（ノイズ除去）を推奨。［Sec. 2.5］

## 2) 深度順エネルギー（隣接ペア）
- 定義: 隣接する二つのレイヤ（A, B）の前後関係を、遮蔽の整合性に基づくエネルギーで評価。論文では「深度順エネルギー」を定義し、(2) 式として提示。内容は、遮蔽で一致すべき輪郭の“被覆度”に関連する比率で、1 に近いほど片方が他方を覆う仮説を支持する。［Sec. 2.1, Def. 3, Eq. (2)］
- 近接判定: 共有境界や近接度から隣接ペアを構築。候補エッジに上記スコアを格納。［Sec. 2.1, Remark 4］
 - 実装詳細: エネルギー (2) の計算に関する実装注意点（近傍幅、数値安定化など）。［Sec. 5.1］

## 3) 循環（閉路）の回避と全体整序
- 課題: 局所的な前後スコアを集約すると、矛盾（A≺B≺C≺A）が生じ得る。［Sec. 2.2］
- 対応: 論文は「凸包対称差エネルギー」を導入し、閉路を壊す方向にグローバルな整序を誘導する（(4), (5) 式）。実装としては、辺重みの最小フィードバック弧集合の近似や、重み付きトポロジカルソートに相当する処理で全順序化する。［Sec. 2.2, Eqs. (4)(5); Sec. 5.3（凸包計算とトポロジカルソート）］
- 数値注意: グラフは疎で大規模になり得るため、強連結成分（SCC）分解→縮約 DAG 上での整序が有効。［Sec. 5.3］

## 4) 遮蔽による途切れ輪郭の補完（エラスティカ）
- 目的: 知覚的に自然な補間で閉域を回復する。［Sec. 2.3］
- モデル: Euler's elastica 型の曲率正則化と長さペナルティからなる汎関数最小化（(7) 式）。二重井戸ポテンシャル（Modica–Mortola 型）を用いた位相場で安定化し、連続かつ滑らかな復元を得る。［Sec. 2.3, Eq. (7); Sec. 4.2］
- 数値: 多段（粗→密）最適化、反復ごとの安定化（スムージング）と停止条件。［Sec. 5.2］
- 幾何拘束: 端点位置・接線方向の連続（G1 以上）と自己交差回避（ペナルティ）。［Sec. 2.3; Sec. 4.1（角の扱い）］

## 5) ベクタ化と SVG 出力
- 近似: 補完後の境界を Bézier（2次/3次）で近似し、曲率変化に応じて節点密度を自動調整。［Sec. 2.4; Sec. 6.2］
- 出力: 深度順に `<g id="layer-XXX" data-depth="d">` として重ね、レイヤ編集を容易にする。［Sec. 6.2（SVG編集例）］

## 6) 重要パラメータと設計指針
- 深度しきい値 `delta`: ペアスコアが僅差の場合の保留・同順序扱いの閾値。循環回避エネルギーと併用。［Sec. 2.1, Remark 4; Sec. 2.2］
- エラスティカ重み `λc, λl`: 曲率・長さのトレードオフ。薄い形状では曲率重みを弱める。［Sec. 2.3, Eq. (7)］
- 二重井戸項 `a, b`: 形状位相場の安定化パラメータ。［Sec. 4.2］
- 近傍幅 `epsilon`: 共有境界の近傍帯域幅（数値安定性）。［Sec. 5.2］

## 7) SvgCreator 実装設計（提案）
- データ構造
  - `Region`: ピクセル集合・外接矩形・境界ポリライン。
  - `AdjGraph`: 領域ノード、隣接辺（前後スコア、確信度、共有境界長）。
  - `DepthOrder`: 全順序配列と `data-depth` マップ。
  - `Path`: スプライン制御点＋単純化トレランス。
- 処理ステージ
  1) `segmentation()`: 量子化→連結成分→微小除去。
  2) `build_graph()`: 隣接検出→スコア算出（Sec. 2.1）。
  3) `order_layers()`: 閉路ペナルティ（Sec. 2.2）→SCC 縮約→トポロジカルソート。
  4) `inpaint_occlusion()`: 各レイヤの遮蔽領域でエラスティカ最小化（Sec. 2.3, 4.2, 5.2）。
  5) `vectorize()`: 境界近似→RDP+曲率閾値で単純化（Sec. 2.4）。
  6) `emit_svg()`: `<g>` 分割とメタ付与（Sec. 6.2）。
- 失敗時のフォールバック
  - 閉路解消が収束しない: 重み丸め＋優先順位（共有境界長の長い方を優先）で決定。［Sec. 2.2 の動機に整合］
  - エラスティカが不安定: 長さ重みを強め、反復上限で打切り→直線補間にダウングレード。［Sec. 5.2］

## 8) CLI への写像（候補）
- `--quality {fast|balanced|high}`: 量子化 K、曲率重み、反復回数のプリセット。
- `--delta <float>`: 深度しきい値（Sec. 2.1）。
- `--epsilon <float>`: 近傍帯域幅（Sec. 5.2）。
- `--euler-max-iter <int>`: エラスティカ反復上限（Sec. 5.2）。
- `--a <float> --b <float>`: 二重井戸項パラメータ（Sec. 4.2）。
- `--export-layer <id[,id...]>`: レイヤ部分出力（既要件に一致）。
- `--threads <int>`: 並列度（エッジ評価・ベクタ化で適用）。
（参考: 公開実装では `K`, `delta`, `euler_max_iter`, `epsilon`, `a`, `b` 等のパラメータが CLI として提示されている）［GitHub README］

## 9) パフォーマンス見積もり
- 主要ボトルネックは隣接ペア評価 O(E) とエラスティカ（各レイヤの局所 PDE 最適化）。
- 実装では SCC 縮約と辺の枝刈り（短い共有境界を閾切り）で E を削減。［Sec. 5.3］

## 10) 検証計画
- 定性: 人手での前後関係評価（サンプル 50 枚）。［Sec. 6.2 の編集例に準拠］
- 定量: レイヤ単位の境界滑らかさ（離散曲率分散）、SVG サイズ（<=15KB/レイヤ）、閉路率 0%。

## 参考（原典の節）
- Sec. 2.1 Depth ordering energy（Def. 3, Eq. (2) ほか）
- Sec. 2.2 Convex hull symmetric difference energy（Eqs. (4)(5)）
- Sec. 2.3 Euler’s elastica energy for curve completion（Eq. (7)）
- Sec. 2.4 Bézier curve approximation for SVG
- Sec. 2.5 Outline of the proposed method（Appx. A: Pseudo Code）
- Sec. 4.1 Corner phase function, Sec. 4.2 Modified double-well potential
- Sec. 5.2 Numerical details for elastica, Sec. 5.3 Convex hull and topological sort
- Sec. 6.2 Easy editing with SVG files
